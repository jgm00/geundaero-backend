<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hexagon_talent.geundaero.domain.auth.dao.UserDAO">

    <select id="existingUser" parameterType="long" resultType="boolean">
        SELECT EXISTS ( SELECT 1 FROM users WHERE kakao_id = #{kakaoId} )
    </select>

    <insert id="insertUser"
            parameterType="hexagon_talent.geundaero.domain.auth.dto.request.KakaoProfileDTO">
        INSERT INTO users (kakao_id, email, name, profile_image)
        VALUES (
        #{id},
        #{kakao_account.email},
        COALESCE(NULLIF(#{nickname, jdbcType=VARCHAR}, ''), '카카오유저'),
        COALESCE(NULLIF(#{profile_image, jdbcType=VARCHAR}, ''), '/images/default-profile.png')
        )
    </insert>

    <select id="findById" parameterType="long"
            resultType="hexagon_talent.geundaero.domain.auth.entity.User">
        SELECT
        id,
        name,
        email,
        profile_image  AS profileImage,
        kakao_id       AS kakaoId,
        created_at     AS createdAt,
        updated_at     AS updatedAt
        FROM users
        WHERE id = #{id}
    </select>

    <select id="findByEmail" parameterType="string"
            resultType="hexagon_talent.geundaero.domain.auth.entity.User">
        SELECT
        id,
        name,
        email,
        profile_image  AS profileImage,
        kakao_id       AS kakaoId,
        created_at     AS createdAt,
        updated_at     AS updatedAt
        FROM users
        WHERE email = #{email}
    </select>

    <select id="findByKakaoId" parameterType="long"
            resultType="hexagon_talent.geundaero.domain.auth.entity.User">
        SELECT
        id,
        name,
        email,
        profile_image  AS profileImage,
        kakao_id       AS kakaoId,
        created_at     AS createdAt,
        updated_at     AS updatedAt
        FROM users
        WHERE kakao_id = #{kakaoId}
    </select>
    <insert id="upsertUser"
            parameterType="hexagon_talent.geundaero.domain.auth.dto.request.KakaoProfileDTO">
        INSERT INTO users (kakao_id, email, name, profile_image, created_at, updated_at)
        VALUES (
        #{id},
        #{kakao_account.email},
        COALESCE(NULLIF(#{kakao_account.profile.nickname, jdbcType=VARCHAR}, ''),
        NULLIF(#{properties.nickname, jdbcType=VARCHAR}, ''), '카카오유저'),
        COALESCE(NULLIF(#{kakao_account.profile.profile_image_url, jdbcType=VARCHAR}, ''),
        NULLIF(#{properties.profile_image, jdbcType=VARCHAR}, ''),
        '/images/default-profile.png'),
        NOW(), NOW()
        )
        ON DUPLICATE KEY UPDATE
        name = VALUES(name),
        email = VALUES(email),
        profile_image = VALUES(profile_image),
        updated_at = NOW();
    </insert>
</mapper>
